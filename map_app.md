# Карта Приложения BananaCrunch — Подробный Обзор

Этот документ представляет собой исчерпывающее руководство по архитектуре и структуре проекта BananaCrunch. Он описывает каждый файл, его роль, ключевые функции и взаимодействия внутри приложения.

## 1. Точка входа и конфигурация

### `index.html`
- **Назначение**: Главный HTML-файл, служащий точкой входа для браузера.
- **Ключевые элементы**:
  - `<div id="root"></div>`: Корневой элемент, в который React монтирует приложение.
  - `<script type="importmap">`: Определяет псевдонимы для импорта библиотек (`react`, `@google/genai`) с CDN, что устраняет необходимость в локальной установке `node_modules`.
  - `<script type="module" src="/index.tsx">`: Загружает и выполняет основной скрипт приложения.
  - Подключение шрифта `Space Grotesk` и базовые стили для скроллбара и фона `checkerboard`.

### `index.tsx`
- **Назначение**: Точка входа для React. Отвечает за рендеринг основного компонента `App` в DOM.
- **Логика**:
  - Находит элемент `#root`.
  - Создает React-корень с помощью `ReactDOM.createRoot`.
  - Рендерит компонент `<App />` в режиме `<React.StrictMode>`.

### `metadata.json`
- **Назначение**: Конфигурационный файл для среды выполнения (например, AI Studio).
- **Содержимое**:
  - `name`: Название проекта.
  - `description`: Описание, которое отображается в интерфейсе AI Studio.
  - `requestFramePermissions`: Список разрешений, которые приложение запрашивает у среды (в данном случае пуст, так как камера/микрофон не используются).

## 2. Основная логика и состояние (Hooks)

### `hooks/useAppLog.ts`
- **Назначение**: Инкапсулирует логику для ведения журнала действий и истории промптов.
- **Экспортирует `useAppLog`**:
  - **Состояние**:
    - `logs: LogEntry[]`: Массив всех событий в приложении (действия, запросы к API, ошибки).
    - `promptHistory: PromptHistoryEntry[]`: Массив всех отправленных пользователем промптов с тегами.
  - **Функции**:
    - `addLog(type, message, payload)`: Добавляет новую запись в `logs`.
    - `addPromptToHistory({ prompt, tags })`: Добавляет новый промпт в историю, избегая дубликатов подряд.
    - `setLogs`: Позволяет напрямую установить состояние логов (используется для очистки).

### `hooks/useWorkspace.ts`
- **Назначение**: Управляет состоянием всего рабочего пространства (холста): изображения, выделение, история действий (undo/redo).
- **Экспортирует `useWorkspace`**:
  - **Состояние**:
    - `workspaceImages: WorkspaceImage[]`: Основной массив объектов изображений на холсте.
    - `manualSelectedImageIds: number[]`: ID изображений, выделенных пользователем вручную.
    - `canvasHistory: WorkspaceImage[][]`: Массив состояний `workspaceImages` для реализации undo/redo.
    - `canvasHistoryIndex: number`: Указатель на текущее состояние в `canvasHistory`.
  - **Функции**:
    - `handleWorkspaceUpdate(updater, addToHistory)`: Основная функция для обновления `workspaceImages`. Создает новую запись в истории, если `addToHistory` равно `true`.
    - `handleDeleteSelected()`: Удаляет выделенные изображения.
    - `handleResetCanvas()`: Очищает холст и все связанные состояния.
    - `handleAddImage(files)`: Обрабатывает загрузку новых файлов, создает для них объекты `WorkspaceImage` и добавляет на холст.
    - `handleUndoCanvas()` / `handleRedoCanvas()`: Перемещают указатель `canvasHistoryIndex` и восстанавливают предыдущее/следующее состояние холста.

### `hooks/useGenerationApi.ts`
- **Назначение**: Центральный хук для всей логики взаимодействия с Gemini API.
- **Экспортирует `useGenerationApi`**:
  - **Состояние**:
    - `loadingAction: 'generate' | ... | null`: Указывает, какая операция выполняется в данный момент (для отображения индикаторов загрузки).
    - `loadingMessage: string`: Текст, отображаемый во время загрузки.
    - `error: string | null`: Сообщение об ошибке для отображения пользователю.
  - **Ключевые функции-обработчики**:
    - `handleGenerate()`: Основная функция генерации. Подготавливает промпт (с учетом "Magic Prompt"), собирает изображения и их аннотации, отправляет запрос к API и обрабатывает ответ.
    - `handleReasoning()`: Отправляет запрос к модели для получения "плана" действий в виде JSON, парсит его и добавляет аннотации на изображение перед запуском `handleGenerate`.
    - `handleEnhance()` / `handleRtxGenerate()`: Функции для улучшения качества/стиля изображения с предопределенными промптами.
    - `handleMix()`: Функция для "смешивания" слоев и аннотаций в единую сцену, используя "Magic Prompt" для генерации идеи.
    - `handleRegenerate(imageId)`: Повторяет последний запрос генерации для указанного изображения, используя сохраненный `generationContext`.
    - `handleResizeAndGenerate(...)`: Специализированная функция для генерации в режиме "outpainting" (дорисовки) при изменении соотношения сторон.
  - **Вспомогательные функции**: `getImageData`, `processApiResponse`, `getErrorMessageFromResponse`.

### `hooks/useWorkspaceInput.ts`
- **Назначение**: Изолирует всю сложную логику обработки пользовательского ввода на холсте (`WorkspaceCanvas`) от самого компонента.
- **Экспортирует `useWorkspaceInput`**:
  - **Состояние**:
    - `cursorStyle: string`: Текущий стиль курсора.
    - `marquee: { start, end } | null`: Координаты рамки выделения.
  - **Функции-обработчики**: `handleWheel`, `handlePointerDown`, `handlePointerMove`, `handlePointerUp`.
  - **Логика**:
    - Реализует машину состояний (`actionRef`) для отслеживания текущего действия: `pan`, `drag`, `resize`, `marquee` и т.д.
    - Управляет масштабированием (зумом) и панорамированием холста.
    - Обрабатывает логику выделения изображений (кликом, с `Shift`, рамкой).
    - Управляет перемещением и изменением размера изображений, включая пропорциональное изменение с `Ctrl/Cmd`.
    - Содержит специфичную логику для взаимодействия в режиме редактирования соотношения сторон (`outpaintingState`).

## 3. Главный компонент и структура UI

### `App.tsx`
- **Назначение**: Корневой компонент приложения, который собирает все части вместе.
- **Структура**:
  - **Управление состоянием**: Использует `useState` для управления состоянием UI (видимость модальных окон, активный инструмент, режим `canvas`/`editor`).
  - **Использование хуков**: Инициализирует и связывает основные хуки: `useAppLog`, `useWorkspace`, `useGenerationApi`.
  - **Производное состояние**: `useMemo` используется для вычисления `combinedSelectedImageIds` (объединение ручного выделения и @-ссылок в промпте) и `selectedImages`.
  - **Обработчики событий**: Содержит глобальные обработчики `keydown` (горячие клавиши) и `paste`.
  - **Рендеринг**:
    - Условно отображает либо `<WorkspaceCanvas>`, либо `<ImageEditor>` в зависимости от `viewMode`.
    - Рендерит все панели инструментов (`LeftToolbar`, `RightToolbar`, `GenerationBar`, `Header`).
    - Управляет отображением всех модальных окон (`InfoModal`, `PresetsModal` и т.д.).

## 4. Основные компоненты холста и редактора

### `components/WorkspaceCanvas.tsx`
- **Назначение**: "Умный" компонент, отвечающий за отображение и взаимодействие с основным рабочим холстом.
- **Ключевая логика**:
  - Использует `useWorkspaceInput` для всей обработки ввода.
  - Управляет состоянием `outpaintingState` для режима редактирования соотношения сторон.
  - Реализует основной цикл отрисовки (`renderCanvas`) с помощью `requestAnimationFrame`.
  - **Отрисовка**:
    - Рисует все `workspaceImages`, их слои, рамки выделения, теги (`@1`).
    - Отображает индикаторы загрузки и плавающую панель действий (`FloatingActionBar`).
    - Управляет UI для редактирования соотношения сторон (`AspectRatioEditorUI`).
  - **`useImperativeHandle`**: Предоставляет родительскому компоненту (`App`) методы для управления холстом: `resetView`, `getAnnotatedImage`, `focusOnImage` и др.

### `components/ImageEditor.tsx`
- **Назначение**: Компонент для полноэкранного редактирования одного изображения (добавление аннотаций и слоев).
- **Ключевая логика**:
  - **Два Canvas**: Использует `displayCanvas` для отображения с учетом зума/панорамирования и `fullCanvas` (или `OffscreenCanvas`) для отрисовки в полном разрешении.
  - **Управление состоянием**: Собственная система истории (`history`, `historyIndex`) для аннотаций, управление слоями (`localLayers`), активным слоем (`activeLayerId`).
  - **Обработка ввода**: Содержит собственную логику для `handlePointerDown/Move/Up` для рисования, перемещения и изменения размера слоев.
  - **Инструменты**: Реализует логику для всех инструментов (`Brush`, `Lasso`, `Arrow`, `Text`).
  - **`useImperativeHandle`**: Предоставляет методы `undo`, `redo`, `clearAnnotations`, `addLayer` и др.

## 5. Компоненты UI

### Панели инструментов и бары
- **`components/Header.tsx`**: Верхняя панель с названием, ссылками и кнопками управления (лог, инфо, донат). Реализует выпадающее меню для мобильных устройств.
- **`components/LeftToolbar.tsx`**: Панель инструментов для режима `ImageEditor`. Содержит выбор инструментов рисования, цвета и размера кисти.
- **`components/RightToolbar.tsx`**: Контекстно-зависимая панель. Содержит undo/redo, инструменты навигации (`Selection`, `Hand`) и кнопку очистки.
- **`components/GenerationBar.tsx`**: Нижняя панель для ввода промпта и запуска генерации.
  - **Элементы**: `textarea` с подсветкой @-ссылок, кнопки для добавления изображений и вызова пресетов, переключатель "Magic Prompt", кнопки "Reasoning" и "Generate".
  - **Логика**: Управляет собственным размером (шириной и высотой) через перетаскивание границ.
- **`components/workspace/FloatingActionBar.tsx`**: Плавающая панель, появляющаяся над выделенным изображением на холсте. Предоставляет быстрый доступ к действиям: редактировать, перегенерировать, скачать, удалить и т.д.

### Модальные окна
- **`components/InfoModal.tsx`**: Отображает подробное руководство по использованию приложения, сгруппированное в разделы-аккордеоны.
- **`components/ChangelogModal.tsx`**: Показывает историю версий и изменений в приложении.
- **`components/PresetsModal.tsx`**: Окно с большим списком готовых промптов. Реализует поиск и фильтрацию по тегам.
- **`components/PromptEditorModal.tsx`**: Полноэкранный редактор для длинных промптов.
- **`components/ActionLog.tsx`**: Консоль, отображающая либо журнал действий (`logs`), либо историю промптов (`promptHistory`).
- **`components/DonateModal.tsx`**, **`components/HallOfFameModal.tsx`**: Информационные модальные окна.

### Вспомогательные компоненты
- **`components/Icon.tsx`**: Библиотека SVG-иконок. Принимает `name` и возвращает соответствующую иконку.
- **`components/Tooltip.tsx`**: Простой компонент-обертка для отображения всплывающих подсказок.
- **`components/AsciiBackground.tsx`**: Компонент, создающий анимированный фон из ASCII-символов, который реагирует на движение курсора с эффектом "тепла" и физикой притяжения.
- **`components/workspace/AspectRatioEditorUI.tsx`**: Презентационный компонент, отвечающий только за UI редактирования соотношения сторон (кнопки, инпуты).
  
## 6. Утилиты и данные

### `types.ts`
- **Назначение**: Центральный файл для всех TypeScript-типов и интерфейсов (`WorkspaceImage`, `AnyLayer`, `Tool`, `LogEntry` и др.).

### `constants.ts`
- **Назначение**: Хранит строковые константы, в основном системные промпты для `REASONING`, `MAGIC_PROMPT` и `OUTPAINTING`.

### `presets.ts`
- **Назначение**: Содержит огромный массив данных для пресетов, сгруппированных по категориям и переведенных на два языка.
- **`getPresetData(lang)`**: Функция для получения массива пресетов на выбранном языке.

### `i18n.ts`
- **Назначение**: Реализует простую систему интернационализации.
- **`useTranslations(lang)`**: Хук, который возвращает функцию `t(key)`, используемую во всем приложении для получения переведенных строк.

### `components/workspace/drawing.ts`
- **Назначение**: Содержит чистую функцию `drawLayer`, которая принимает контекст canvas и объект слоя и отрисовывает его. Вынесена из `WorkspaceCanvas` и `ImageEditor` для переиспользования и чистоты кода.

### `components/workspace/geometry.ts`
- **Назначение**: Набор чистых математических функций для геометрических вычислений, используемых в `useWorkspaceInput`.
- **Функции**: `isOverRect`, `getImageAtPosition`, `getResizeHandleAtPosition`, `calculateNewResizeAttributes` и др.
